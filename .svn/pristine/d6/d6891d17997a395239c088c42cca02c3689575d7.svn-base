package com.alpha.self.diagnosis.service.impl;

import static java.util.stream.Collectors.toList;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import com.alpha.commons.core.service.SysSequenceService;
import com.alpha.self.diagnosis.pojo.BasicAnswer;
import com.alpha.self.diagnosis.pojo.BasicQuestion;
import com.alpha.self.diagnosis.pojo.vo.BasicAnswerVo;
import com.alpha.self.diagnosis.pojo.vo.BasicQuestionVo;
import com.alpha.self.diagnosis.pojo.vo.IAnswerVo;
import com.alpha.self.diagnosis.service.BasicAnswerService;
import com.alpha.self.diagnosis.service.BasicQuestionService;
import com.alpha.self.diagnosis.service.DiagnosisService;
import com.alpha.server.rpc.diagnosis.pojo.UserBasicRecord;
import com.alpha.server.rpc.user.pojo.UserMember;
import com.alpha.user.service.UserBasicRecordService;
import com.alpha.user.service.UserMemberService;

@Service
@Transactional
public class DiagnosisServiceImpl implements DiagnosisService {
	
	@Resource
	private UserMemberService userMemberService; 
	@Resource
	private SysSequenceService sysSequenceService;
	@Resource
	private BasicQuestionService basicQuestionService;
	@Resource
	private BasicAnswerService basicAnswerService;
	@Resource
	private UserBasicRecordService userBasicRecordService;

	@Override
	@Transactional(readOnly = false, propagation = Propagation.REQUIRED)
	public BasicQuestionVo start(Long userId, Integer inType) {
		String questionCode = null;
		Long diagnosisId = sysSequenceService.getNextSequence("diagnosis_seq");
		//获取第一个问题
		BasicQuestion param = new BasicQuestion(1, null, null, null, null);
		BasicQuestion question = basicQuestionService.find(param);
		if(question != null) {
			questionCode = question.getQuestionCode();
		}
		//获取第一个问题的答案
		List<BasicAnswer> answerList = basicAnswerService.findByQuestionCode(questionCode);
		//获取用户下的成员
		Map<String, Object> map = new HashMap<>();
		map.put("userId", userId);
		List<UserMember> userMemberList = userMemberService.find(map);
		
		List<IAnswerVo> answervoList = new ArrayList<>(); 
		List<BasicAnswerVo> defaultAnswervoList = answerList.stream().map(BasicAnswerVo::new).collect(toList());
		//将自己的answerCode设置为userId,将他人的answerCode设置为0
		defaultAnswervoList.stream().peek(e->updateAnswerVo(e, userId)).collect(toList());
		List<BasicAnswerVo> answervoList4userMember = userMemberList.stream().map(BasicAnswerVo::new).collect(toList());
		answervoList.addAll(defaultAnswervoList);
		answervoList.addAll(answervoList4userMember);
		//添加就诊记录
		UserBasicRecord record = new UserBasicRecord();
		record.setDiagnosisId(diagnosisId);
		userBasicRecordService.addUserBasicRecord(record);
		return new BasicQuestionVo(diagnosisId, question, answervoList, null);
	}

	private void updateAnswerVo(BasicAnswerVo basicAnswer, Long userId) {
		String answerCode = "0";
		if("自己".equals(basicAnswer.getAnswerTitle())) {	//自己
			answerCode = String.valueOf(userId);
			basicAnswer.setAnswerCode(answerCode);
			basicAnswer.setAnswerValue(answerCode);
		} if("他人".equals(basicAnswer.getAnswerTitle())) { //他人
			basicAnswer.setAnswerCode(answerCode);
			basicAnswer.setAnswerValue(answerCode);
		}
	}
}
